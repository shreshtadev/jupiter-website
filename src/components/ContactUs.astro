---
// Get the public site key from environment variables
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

const projectType = [
    { value: "webapp", label: "Web application" },
    { value: "mobileapp", label: "Mobile app" },
    { value: "staticweb", label: "Static website" },
    { value: "saas", label: "Application Interfaces" },
    { value: "consulting", label: "Consulting" },
    { value: "other", label: "Other" },
];
---

<section class="py-24" id="contact">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <div
                class="bg-base-200 rounded-3xl overflow-hidden shadow-xl border border-base-300"
            >
                <div class="flex flex-col lg:flex-row">
                    <div
                        class="lg:w-2/5 bg-primary p-8 md:p-12 text-primary-content flex flex-col"
                    >
                        <div class="mb-10">
                            <h2 class="text-3xl font-bold mb-6">
                                Let's build something!
                            </h2>
                            <p class="mb-8 opacity-90">
                                Have a project in mind? I'd love to hear about
                                it. Fill out the form and I'll get back to you
                                within 24 hours.
                            </p>
                            <div class="space-y-4">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-10 h-10 rounded-full bg-primary-content/20 flex items-center justify-center shrink-0"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            ><path
                                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                                            ></path></svg
                                        >
                                    </div>
                                    <span class="font-medium"
                                        >+91 9110821035</span
                                    >
                                </div>
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-10 h-10 rounded-full bg-primary-content/20 flex items-center justify-center shrink-0"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="20"
                                            height="20"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            ><path
                                                d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                                            ></path><polyline
                                                points="22,6 12,13 2,6"
                                            ></polyline></svg
                                        >
                                    </div>
                                    <span class="font-medium"
                                        >shreshtasmg@gmail.com</span
                                    >
                                </div>
                            </div>
                        </div>

                        <div
                            class="mt-auto rounded-2xl overflow-hidden h-64 border-4 border-primary-content/10 shadow-inner"
                        >
                            <iframe
                                src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d3872.174812181066!2d75.5397439!3d13.9481947!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bbbafea66e693c1%3A0x792566a84a992237!2sJai%20Bhavani%20Nivas!5e0!3m2!1sen!2sin!4v1767183019091!5m2!1sen!2sin"
                                width="600"
                                height="450"
                                style="border:0;"
                                allowfullscreen=""
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade"
                                class="grayscale contrast-125"></iframe>
                        </div>
                    </div>

                    <div class="lg:w-3/5 p-8 md:p-12 bg-base-100">
                        <form id="contact-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-control w-full">
                                    <label class="label"
                                        ><span class="label-text font-semibold"
                                            >Name</span
                                        ></label
                                    >
                                    <input
                                        type="text"
                                        name="name"
                                        placeholder="John Doe"
                                        class="input input-bordered w-full bg-base-200 focus:input-primary"
                                        required
                                    />
                                </div>
                                <div class="form-control w-full">
                                    <label class="label"
                                        ><span class="label-text font-semibold"
                                            >Email Address</span
                                        ></label
                                    >
                                    <input
                                        type="email"
                                        name="email"
                                        placeholder="john@example.com"
                                        class="input input-bordered w-full bg-base-200 focus:input-primary"
                                        required
                                    />
                                </div>
                            </div>

                            <div class="form-control w-full">
                                <label class="label"
                                    ><span class="label-text font-semibold"
                                        >What are you looking for?</span
                                    ></label
                                >
                                <select
                                    name="projectType"
                                    class="select select-bordered w-full bg-base-200 focus:select-primary"
                                    required
                                >
                                    <option disabled selected value=""
                                        >Select a category</option
                                    >
                                    {
                                        projectType.map((item) => (
                                            <option value={item.value}>
                                                {item.label}
                                            </option>
                                        ))
                                    }
                                </select>
                            </div>

                            <div class="form-control w-full">
                                <label class="label"
                                    ><span class="label-text font-semibold"
                                        >Project Details</span
                                    ></label
                                >
                                <textarea
                                    name="message"
                                    class="textarea textarea-bordered w-full min-h-[150px] bg-base-200 focus:textarea-primary"
                                    placeholder="Tell me about your goals, timeline, and any specific requirements..."
                                    required></textarea>
                            </div>

                            <div
                                class="flex flex-wrap items-center justify-between gap-4 pt-4"
                            >
                                <button
                                    type="submit"
                                    class="btn btn-primary btn-wide normal-case text-lg shadow-lg"
                                    id="contact-submit-btn"
                                >
                                    Send Message
                                </button>
                                <a
                                    href="#top"
                                    class="btn btn-ghost btn-sm opacity-60 hover:opacity-100 transition-opacity"
                                >
                                    Back to top â†‘
                                </a>
                            </div>

                            <p
                                class="text-xs text-base-content/50 pt-4 border-t border-base-300"
                            >
                                This site is protected by reCAPTCHA and the
                                Google
                                <a
                                    href="https://policies.google.com/privacy"
                                    class="link link-hover text-primary"
                                    >Privacy Policy</a
                                > and
                                <a
                                    href="https://policies.google.com/terms"
                                    class="link link-hover text-primary"
                                    >Terms of Service</a
                                > apply.
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script define:vars={{ RECAPTCHA_SITE_KEY }}>
    window.RECAPTCHA_SITE_KEY = RECAPTCHA_SITE_KEY;
</script>

<script>
    import { actions } from "astro:actions";

    const form = document.getElementById("contact-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
        "contact-submit-btn",
    ) as HTMLButtonElement;
    const siteKey = (window as any).RECAPTCHA_SITE_KEY;

    if (form) {
        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            if (!(window as any).grecaptcha) {
                alert("reCAPTCHA is loading. Please wait a moment.");
                return;
            }

            submitBtn.disabled = true;
            const originalText = submitBtn.innerText;
            submitBtn.innerHTML =
                '<span class="loading loading-spinner loading-sm"></span> Sending...';

            try {
                const token = await new Promise<string>((resolve, reject) => {
                    (window as any).grecaptcha.ready(() => {
                        (window as any).grecaptcha
                            .execute(siteKey, { action: "contact_form" })
                            .then(resolve)
                            .catch(reject);
                    });
                });

                const formData = new FormData(form);
                const { data, error } = await actions.contactUs({
                    name: formData.get("name") as string,
                    email: formData.get("email") as string,
                    projectType: formData.get("projectType") as string,
                    message: formData.get("message") as string,
                    recaptchaToken: token,
                });

                if (error) throw new Error(error.message);

                // Redirect on success
                window.location.href = "/?submitted=true";
            } catch (err: any) {
                console.error("Submission error:", err);
                alert(
                    err.message ||
                        "Something went wrong. Please check your connection.",
                );
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });
    }
</script>
